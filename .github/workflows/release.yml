name: Release

on:
  push:
    branches: [master]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      - name: Get version and SHA
        id: info
        run: |
          VERSION=$(grep -oP '(?<=<Version>)[^<]+' Krypton-Server/Krypton-Server.csproj | head -1)
          SHA=${GITHUB_SHA::7}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "tag=$VERSION-$SHA" >> $GITHUB_OUTPUT

      - name: Generate BuildContributors.cs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CONTRIBUTORS=$(curl -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/contributors?per_page=5" | \
            jq -r '[.[].login | "\"" + . + "\""] | join(", ")')
          cat > Krypton-Server/BuildContributors.cs << 'CSEOF'
          // Auto-generated â€” CI overwrites before each release build
          namespace Krypton.Server;

          internal static class BuildContributors
          {
              public static readonly string[] Top5 = [CONTRIBUTORS_PLACEHOLDER];
          }
          CSEOF
          sed -i "s/CONTRIBUTORS_PLACEHOLDER/$CONTRIBUTORS/" Krypton-Server/BuildContributors.cs

      - name: Publish Desktop (win-x64)
        run: |
          dotnet publish Krypton-Desktop/Krypton-Desktop.csproj \
            -c Release -r win-x64 --no-self-contained \
            -p:PublishSingleFile=true \
            -p:SourceRevisionId=${{ steps.info.outputs.sha }} \
            -o artifacts/win-x64
          mv artifacts/win-x64/Krypton-Desktop.exe \
             artifacts/krypton-desktop-win-x64.exe

      - name: Publish Desktop (linux-x64)
        run: |
          dotnet publish Krypton-Desktop/Krypton-Desktop.csproj \
            -c Release -r linux-x64 --no-self-contained \
            -p:PublishSingleFile=true \
            -p:SourceRevisionId=${{ steps.info.outputs.sha }} \
            -o artifacts/linux-x64
          mv artifacts/linux-x64/Krypton-Desktop \
             artifacts/krypton-desktop-linux-x64
          chmod +x artifacts/krypton-desktop-linux-x64

      - name: Publish Desktop (osx-x64)
        run: |
          dotnet publish Krypton-Desktop/Krypton-Desktop.csproj \
            -c Release -r osx-x64 --no-self-contained \
            -p:PublishSingleFile=true \
            -p:SourceRevisionId=${{ steps.info.outputs.sha }} \
            -o artifacts/osx-x64
          cd artifacts/osx-x64
          zip -r ../krypton-desktop-osx-x64.zip Krypton-Desktop.app

      - name: Publish Desktop (osx-arm64)
        run: |
          dotnet publish Krypton-Desktop/Krypton-Desktop.csproj \
            -c Release -r osx-arm64 --no-self-contained \
            -p:PublishSingleFile=true \
            -p:SourceRevisionId=${{ steps.info.outputs.sha }} \
            -o artifacts/osx-arm64
          cd artifacts/osx-arm64
          zip -r ../krypton-desktop-osx-arm64.zip Krypton-Desktop.app

      - name: Publish Server (linux-x64)
        run: |
          dotnet publish Krypton-Server/Krypton-Server.csproj \
            -c Release -r linux-x64 --no-self-contained \
            -p:PublishSingleFile=true \
            -p:SourceRevisionId=${{ steps.info.outputs.sha }} \
            -o artifacts/server
          mv artifacts/server/Krypton-Server \
             artifacts/krypton-server-linux-x64
          chmod +x artifacts/krypton-server-linux-x64

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.info.outputs.tag }}
          name: Krypton ${{ steps.info.outputs.version }} (${{ steps.info.outputs.sha }})
          generate_release_notes: true
          files: |
            artifacts/krypton-desktop-win-x64.exe
            artifacts/krypton-desktop-linux-x64
            artifacts/krypton-desktop-osx-x64.zip
            artifacts/krypton-desktop-osx-arm64.zip
            artifacts/krypton-server-linux-x64
